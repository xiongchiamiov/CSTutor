<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>code coverage of views.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">

<style type="text/css">
pre.code {
    font-style: Lucida,"Courier New";
}
.number {
    color: #0080C0;
}
.operator {
    color: #000000;
}
.string {
    color: #008000;
}
.comment {
    color: #808080;
}
.name {
    color: #000000;
}
.error {
    color: #FF8080;
    border: solid 1.5pt #FF0000;
}
.keyword {
    color: #0000FF;
    font-weight: bold;
}
.text {
    color: #000000;
}
.notcovered {
    background-color: #FFB2B2;
}
</style>

</head>
<body>
<pre class="code">
<span class="string">'''
        Functions in this file allow an instructor to create a course, add users to the course, search for user names, and remove users. In addition, there are functions that allow a student to join a course. 
        @author Jon Inloes, James Pearson, Mark Gius, Matthew Tytel, John Hartquist
'''</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">http</span> <span class="keyword">import</span> <span class="name">Http404</span> <span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">core</span><span class="operator">.</span><span class="name">urlresolvers</span> <span class="keyword">import</span> <span class="name">reverse</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">shortcuts</span> <span class="keyword">import</span> <span class="name">render_to_response</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">http</span> <span class="keyword">import</span> <span class="name">HttpResponseRedirect</span><span class="text">
</span><span class="keyword">from</span> <span class="name">courses</span><span class="operator">.</span><span class="name">models</span> <span class="keyword">import</span> <span class="name">Course</span><span class="text">
</span><span class="keyword">from</span> <span class="name">pages</span><span class="operator">.</span><span class="name">models</span> <span class="keyword">import</span> <span class="name">Page</span><span class="text">
</span><span class="keyword">from</span> <span class="name">courses</span><span class="operator">.</span><span class="name">course</span> <span class="keyword">import</span> <span class="operator">*</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">db</span> <span class="keyword">import</span> <span class="name">IntegrityError</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">template</span><span class="operator">.</span><span class="name">defaultfilters</span> <span class="keyword">import</span> <span class="name">slugify</span><span class="text">
</span><span class="keyword">from</span> <span class="name">home</span><span class="operator">.</span><span class="name">views</span> <span class="keyword">import</span> <span class="name">master_rtr</span><span class="text">
</span><span class="keyword">from</span> <span class="name">django</span><span class="operator">.</span><span class="name">contrib</span><span class="operator">.</span><span class="name">auth</span><span class="operator">.</span><span class="name">decorators</span> <span class="keyword">import</span> <span class="name">login_required</span><span class="text">
</span><span class="keyword">from</span> <span class="name">pages</span><span class="operator">.</span><span class="name">views</span> <span class="keyword">import</span> <span class="name">show_page</span><span class="text">
</span><span class="keyword">import</span> <span class="name">StringIO</span><span class="text">
</span><span class="text">
</span><span class="text">
</span><span class="operator">@</span><span class="name">login_required</span><span class="text">
</span><span class="keyword">def</span> <span class="name">create_course</span><span class="operator">(</span><span class="name">request</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        @author John Hartquist
        @author Matthew Tytel
        
        Creates a new course if course name is long enough
        and the coursename is unique.  If not gives an error.
        Also sets a course to private if the checkbox was checked.
        '''</span><span class="text">
</span><span class="notcovered">        <span class="name">data</span> <span class="operator">=</span> <span class="operator">{</span><span class="operator">}</span></span><span class="text">
</span><span class="notcovered"></span>        <span class="text">
</span><span class="notcovered">        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">method</span> <span class="operator">==</span> <span class="string">"POST"</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="name">name</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'coursename'</span><span class="operator">]</span><span class="operator">.</span><span class="name">strip</span><span class="operator">(</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span>                <span class="text">
</span><span class="notcovered">                <span class="name">private</span> <span class="operator">=</span> <span class="name">False</span><span class="operator">;</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">if</span> <span class="string">"private"</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">private</span> <span class="operator">=</span> <span class="name">True</span><span class="operator">;</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">                <span class="comment"># some basic validation
</span>                <span class="keyword">if</span> <span class="name">len</span><span class="operator">(</span><span class="name">name</span><span class="operator">)</span> <span class="operator">&lt;</span> <span class="number">3</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">data</span><span class="operator">[</span><span class="string">'message'</span><span class="operator">]</span> <span class="operator">=</span> <span class="string">'A Course name must be at least 3 characters.'</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">else</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">c</span> <span class="operator">=</span> <span class="name">CreateCourse</span><span class="operator">(</span><span class="name">name</span><span class="operator">,</span> <span class="name">User</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">username</span><span class="operator">=</span><span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span><span class="operator">,</span> <span class="name">private</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">return</span> <span class="name">HttpResponseRedirect</span><span class="operator">(</span><span class="name">reverse</span><span class="operator">(</span><span class="string">'pages.views.edit_page'</span><span class="operator">,</span> <span class="name">args</span><span class="operator">=</span><span class="operator">[</span><span class="name">c</span><span class="operator">.</span><span class="name">slug</span><span class="operator">,</span> <span class="name">c</span><span class="operator">.</span><span class="name">slug</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">except</span> <span class="name">IntegrityError</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">data</span><span class="operator">[</span><span class="string">'message'</span><span class="operator">]</span> <span class="operator">=</span> <span class="string">'A Course with that name already exists.'</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'courses/create_course.html'</span><span class="operator">,</span> <span class="name">data</span><span class="operator">)</span></span><span class="text">
</span><span class="text">
</span><span class="operator">@</span><span class="name">login_required</span><span class="text">
</span><span class="keyword">def</span> <span class="name">show_roster</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        Displays the roster
        pre: user.isLoggedIn == true
        post: if user.manage then show(roster/index.html) else show(roster/invalid_permissions.html)
        '''</span><span class="text">
</span>        <span class="comment"># It is better to get the enrollment by this method, because in this case
</span>        <span class="comment"># the database searches using Primary Keys, which are indexed, instead of 
</span>        <span class="comment"># username, which is not indexed. -mgius
</span>        <span class="comment">#enrollment = Enrollment.objects.get(user__username__exact=request.user.username, course__slug__exact=course_slug)
</span><span class="text">
</span>        <span class="name">failedList</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">.</span><span class="name">has_key</span><span class="operator">(</span><span class="string">'badusers'</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                <span class="name">failedList</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'badusers'</span><span class="operator">]</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">del</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'badusers'</span><span class="operator">]</span></span><span class="text">
</span>        <span class="text">
</span>        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span>   <span class="text">
</span>        <span class="keyword">except</span> <span class="name">Course</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">raise</span> <span class="name">Http404</span><span class="text">
</span>        <span class="text">
</span>        <span class="name">enrollment</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">course</span><span class="operator">=</span><span class="name">course</span><span class="operator">)</span><span class="text">
</span>        <span class="text">
</span>        <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span><span class="operator">:</span><span class="text">
</span>                <span class="name">enrollments</span> <span class="operator">=</span> <span class="name">course</span><span class="operator">.</span><span class="name">roster</span><span class="operator">.</span><span class="name">all</span><span class="operator">(</span><span class="operator">)</span><span class="operator">;</span><span class="text">
</span><span class="text">
</span>                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'roster/index.html'</span><span class="operator">,</span> \
                                  <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">,</span> \
                                   <span class="string">'enrollments'</span><span class="operator">:</span> <span class="name">enrollments</span><span class="operator">,</span> \
                                   <span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">.</span><span class="name">slug</span><span class="operator">,</span> <span class="string">'failedList'</span><span class="operator">:</span> <span class="name">failedList</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'roster/invalid_permissions.html'</span><span class="operator">,</span> \
                                  <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">,</span> \
                                   <span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">.</span><span class="name">slug</span> <span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">show_course</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">''' Shows the main page of a course. '''</span><span class="text">
</span>        <span class="keyword">return</span> <span class="name">show_page</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="operator">@</span><span class="name">login_required</span><span class="text">
</span><span class="keyword">def</span> <span class="name">add_user</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        Handles the commands given by the add user screen

        pre: none
        post: db'.contains(user) == true and db'.length == db.length + 1 if !db.contains(user)
        '''</span><span class="text">
</span>        <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span>   <span class="text">
</span>        <span class="name">enrollment</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">course</span><span class="operator">=</span><span class="name">course</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span><span class="operator">:</span>   <span class="text">
</span>                <span class="comment">#if the request method was a post determine the command that was given
</span>                <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">method</span> <span class="operator">==</span> <span class="string">'POST'</span><span class="operator">:</span><span class="text">
</span>                <span class="text">
</span>                        <span class="comment">#if the command was an add try to add the user
</span>                        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'command'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'add'</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">usr</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'username'</span><span class="operator">]</span><span class="text">
</span><span class="text">
</span>                                <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                        <span class="comment">#if the user exists add it
</span>                                        <span class="name">user</span> <span class="operator">=</span> <span class="name">User</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">username</span><span class="operator">=</span><span class="name">usr</span><span class="operator">)</span><span class="text">
</span>                                        <span class="name">addUser</span><span class="operator">(</span><span class="name">course</span><span class="operator">,</span> <span class="name">user</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>                                <span class="keyword">except</span> <span class="name">User</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                                        <span class="comment">#if the user does not exist print error message
</span>                                        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'adduser/failed.html'</span><span class="operator">,</span> \
                                                          <span class="operator">{</span><span class="string">'course_slug'</span><span class="operator">:</span><span class="name">course_slug</span><span class="operator">,</span> \
                                                           <span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span>                                <span class="text">
</span>                                <span class="comment">#show the roster screen
</span>                                <span class="keyword">return</span> <span class="name">HttpResponseRedirect</span><span class="operator">(</span><span class="name">reverse</span><span class="operator">(</span><span class="string">'courses.views.show_roster'</span><span class="operator">,</span> <span class="name">args</span><span class="operator">=</span><span class="operator">[</span><span class="name">course_slug</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>                        <span class="keyword">elif</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'command'</span><span class="operator">]</span> <span class="operator">==</span> <span class="string">'search'</span><span class="operator">:</span><span class="text">
</span>                                <span class="comment">#if the command was a search, search for the user
</span>                                <span class="text">
</span>                                <span class="name">firstname</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'firstname'</span><span class="operator">]</span><span class="operator">.</span><span class="name">strip</span><span class="operator">(</span><span class="operator">)</span><span class="text">
</span>                                <span class="name">lastname</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'lastname'</span><span class="operator">]</span><span class="operator">.</span><span class="name">strip</span><span class="operator">(</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>                                <span class="name">users</span> <span class="operator">=</span> <span class="name">User</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">filter</span><span class="operator">(</span><span class="name">first_name</span> <span class="operator">=</span> <span class="name">firstname</span><span class="operator">,</span> <span class="name">last_name</span> <span class="operator">=</span> <span class="name">lastname</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>                                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'adduser/search.html'</span><span class="operator">,</span> \
                                                  <span class="operator">{</span><span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course_slug</span><span class="operator">,</span> \
                                                   <span class="string">'course'</span><span class="operator">:</span><span class="name">course</span><span class="operator">,</span> \
                                                   <span class="string">'users'</span><span class="operator">:</span><span class="name">users</span><span class="operator">,</span> \
                                                   <span class="string">'firstname'</span><span class="operator">:</span> <span class="name">firstname</span><span class="operator">,</span> \
                                                   <span class="string">'lastname'</span><span class="operator">:</span> <span class="name">lastname</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span>                <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span>                        <span class="comment">#display the adduser page
</span><span class="notcovered">                        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span><span class="string">'adduser/index.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">,</span> <span class="string">'url'</span><span class="operator">:</span> <span class="name">request</span><span class="operator">.</span><span class="name">path</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">else</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'roster/invalid_permissions.html'</span><span class="operator">,</span> \
                                <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">,</span> \
                                 <span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course_slug</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="text">
</span><span class="operator">@</span><span class="name">login_required</span><span class="text">
</span><span class="keyword">def</span> <span class="name">update_roster</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
                Updates the roster according to the checkboxes on the page
                pre:none
                post: for all enrollments in db changed(enrollment) in db' 
                      if not removing then db.length = db'.length
        '''</span><span class="text">
</span><span class="text">
</span>        <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span>        <span class="name">enrollment</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">course</span><span class="operator">=</span><span class="name">course</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span><span class="operator">:</span><span class="text">
</span>                <span class="name">editList</span> <span class="operator">=</span>  <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">.</span><span class="name">getlist</span><span class="operator">(</span><span class="string">'edit'</span><span class="operator">)</span><span class="text">
</span>                <span class="name">manageList</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">.</span><span class="name">getlist</span><span class="operator">(</span><span class="string">'manage'</span><span class="operator">)</span><span class="text">
</span>                <span class="name">statsList</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">.</span><span class="name">getlist</span><span class="operator">(</span><span class="string">'stats'</span><span class="operator">)</span><span class="text">
</span>                <span class="name">removeList</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">.</span><span class="name">getlist</span><span class="operator">(</span><span class="string">'remove'</span><span class="operator">)</span><span class="text">
</span>                <span class="name">enrollments</span> <span class="operator">=</span> <span class="name">Enrollment</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">select_related</span><span class="operator">(</span><span class="name">depth</span><span class="operator">=</span><span class="number">1</span><span class="operator">)</span><span class="operator">.</span>\
                                                 <span class="name">filter</span><span class="operator">(</span><span class="name">course__slug__exact</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>                <span class="comment">#for each enrollment
</span>                <span class="keyword">for</span> <span class="name">enrollment</span> <span class="keyword">in</span> <span class="name">enrollments</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">changed</span> <span class="operator">=</span> <span class="name">False</span><span class="text">
</span>                        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">editList</span><span class="operator">.</span><span class="name">index</span><span class="operator">(</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span><span class="text">
</span>                                <span class="comment">#if the user does not have edit permission, then set the permission to true
</span>                                <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">edit</span><span class="operator">:</span><span class="text">
</span>                                        <span class="name">enrollment</span><span class="operator">.</span><span class="name">edit</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                                        <span class="name">changed</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                        <span class="keyword">except</span> <span class="name">ValueError</span><span class="operator">:</span><span class="text">
</span>                                <span class="comment">#if if the user does have edit permission, then set the permission to false
</span>                                <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">edit</span><span class="operator">:</span><span class="text">
</span>                                        <span class="name">enrollment</span><span class="operator">.</span><span class="name">edit</span> <span class="operator">=</span> <span class="name">False</span><span class="text">
</span>                                        <span class="name">changed</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">manageList</span><span class="operator">.</span><span class="name">index</span><span class="operator">(</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span><span class="text">
</span>                                <span class="comment">#if the user does not have manage permission, then set the permission to true
</span>                                <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span><span class="operator">:</span><span class="text">
</span>                                        <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                                        <span class="name">changed</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                        <span class="keyword">except</span> <span class="name">ValueError</span><span class="operator">:</span><span class="text">
</span>                                <span class="comment">#if the user does have manage permission, then set the permission to false
</span>                                <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span><span class="operator">:</span><span class="text">
</span>                                        <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span> <span class="operator">=</span> <span class="name">False</span><span class="text">
</span>                                        <span class="name">changed</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">statsList</span><span class="operator">.</span><span class="name">index</span><span class="operator">(</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span><span class="text">
</span>                                <span class="comment">#if the user does not have stats permission, then set the permission to true
</span>                                <span class="keyword">if</span> <span class="keyword">not</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">stats</span><span class="operator">:</span><span class="text">
</span>                                        <span class="name">enrollment</span><span class="operator">.</span><span class="name">stats</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                                        <span class="name">changed</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                        <span class="keyword">except</span> <span class="name">ValueError</span><span class="operator">:</span><span class="text">
</span>                                <span class="comment">#if the user does have stats permission, then set the permission to false
</span>                                <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">stats</span><span class="operator">:</span><span class="text">
</span>                                        <span class="name">enrollment</span><span class="operator">.</span><span class="name">stats</span> <span class="operator">=</span> <span class="name">False</span><span class="text">
</span>                                        <span class="name">changed</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span><span class="text">
</span>                        <span class="comment">#if the user has changed then update it
</span>                        <span class="keyword">if</span> <span class="name">changed</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">enrollment</span><span class="operator">.</span><span class="name">save</span><span class="operator">(</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>                        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">removeList</span><span class="operator">.</span><span class="name">index</span><span class="operator">(</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span><span class="text">
</span>                                <span class="comment">#if the remove checkbox was checked attempt to remove the user
</span>                                <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                        <span class="comment"># You've already got the course and user objects through the 
</span>                                        <span class="comment"># enrollment object. -mgius
</span>                                        <span class="comment">#user = User.objects.get(username=enrollment.user.username)
</span>                                        <span class="comment">#course = Course.objects.get(slug=course_slug)
</span>                                        <span class="name">removeUser</span><span class="operator">(</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">course</span><span class="operator">,</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="operator">)</span><span class="text">
</span><span class="notcovered">                                <span class="keyword">except</span> <span class="name">User</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                        <span class="keyword">pass</span></span><span class="text">
</span>                        <span class="keyword">except</span> <span class="name">ValueError</span><span class="operator">:</span><span class="text">
</span>                                <span class="keyword">pass</span><span class="text">
</span>                <span class="keyword">return</span> <span class="name">HttpResponseRedirect</span><span class="operator">(</span><span class="name">reverse</span><span class="operator">(</span><span class="string">'courses.views.show_roster'</span><span class="operator">,</span> \
                                                    <span class="name">args</span><span class="operator">=</span><span class="operator">[</span><span class="name">course_slug</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span><span class="text">
</span>        <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'roster/invalid_permissions.html'</span><span class="operator">,</span> \
                                  <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">,</span> <span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">.</span><span class="name">slug</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">cancel_add</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        Redirects to the roster screen when viewing the add user page
        '''</span><span class="text">
</span><span class="notcovered">        <span class="keyword">return</span> <span class="name">HttpResponseRedirect</span><span class="operator">(</span><span class="name">reverse</span><span class="operator">(</span><span class="string">'courses.views.show_roster'</span><span class="operator">,</span> \
                                            <span class="name">args</span><span class="operator">=</span><span class="operator">[</span><span class="name">course_slug</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span></span><span class="text">
</span><span class="text">
</span><span class="operator">@</span><span class="name">login_required</span><span class="text">
</span><span class="keyword">def</span> <span class="name">manage_pending_requests</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        Accepts and denies users in the pending request list for a roster
        pre: user.isLoggedIn = True
        post: (for username in acceptList
                 course.enrollments.username.view = True
              and
              course.enrollments.length' = course.enrollments.length)
              (for username in denyList
                 course.enrollments.remove(username)
              and
              course.enrollments.length' = course.enrollments.length - denyList.length)
        '''</span><span class="text">
</span>        <span class="text">
</span>        <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span>        <span class="name">enrollment</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">course</span><span class="operator">=</span><span class="name">course</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span><span class="operator">:</span><span class="text">
</span>                <span class="name">acceptList</span> <span class="operator">=</span>  <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">.</span><span class="name">getlist</span><span class="operator">(</span><span class="string">'accept'</span><span class="operator">)</span><span class="text">
</span>                <span class="name">denyList</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">.</span><span class="name">getlist</span><span class="operator">(</span><span class="string">'deny'</span><span class="operator">)</span> <span class="text">
</span>                <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">select_related</span><span class="operator">(</span><span class="name">depth</span><span class="operator">=</span><span class="number">2</span><span class="operator">)</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span>                <span class="name">enrollments</span> <span class="operator">=</span> <span class="name">course</span><span class="operator">.</span><span class="name">roster</span><span class="operator">.</span><span class="name">all</span><span class="operator">(</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>                <span class="keyword">for</span> <span class="name">enrollment</span> <span class="keyword">in</span> <span class="name">enrollments</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">user</span> <span class="operator">=</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="text">
</span>                        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">acceptList</span><span class="operator">.</span><span class="name">index</span><span class="operator">(</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span><span class="text">
</span>                                <span class="name">enrollment</span><span class="operator">.</span><span class="name">view</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span>                                <span class="name">enrollment</span><span class="operator">.</span><span class="name">save</span><span class="operator">(</span><span class="operator">)</span><span class="text">
</span>                        <span class="keyword">except</span> <span class="name">ValueError</span><span class="operator">:</span><span class="text">
</span>                                <span class="keyword">pass</span><span class="text">
</span>                        <span class="keyword">try</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">denyList</span><span class="operator">.</span><span class="name">index</span><span class="operator">(</span><span class="name">enrollment</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span><span class="text">
</span>                                <span class="name">removeUser</span><span class="operator">(</span><span class="name">course</span><span class="operator">,</span><span class="name">user</span><span class="operator">)</span><span class="text">
</span>                        <span class="keyword">except</span> <span class="name">ValueError</span><span class="operator">:</span><span class="text">
</span>                                <span class="keyword">pass</span><span class="text">
</span>        <span class="text">
</span>                <span class="keyword">return</span> <span class="name">HttpResponseRedirect</span><span class="operator">(</span><span class="name">reverse</span><span class="operator">(</span><span class="string">'courses.views.show_roster'</span><span class="operator">,</span> \
                                                    <span class="name">args</span><span class="operator">=</span><span class="operator">[</span><span class="name">course_slug</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'roster/invalid_permissions.html'</span><span class="operator">,</span> \
                                  <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">,</span> <span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">.</span><span class="name">slug</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">join_course_form</span><span class="operator">(</span><span class="name">request</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
                Displays a list of unenrolled courses for a user to request to join.
        '''</span><span class="text">
</span><span class="notcovered">        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="name">enrollmentIds</span> <span class="operator">=</span> <span class="operator">[</span><span class="name">e</span><span class="operator">.</span><span class="name">course</span><span class="operator">.</span><span class="name">id</span> <span class="keyword">for</span> <span class="name">e</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">all</span><span class="operator">(</span><span class="operator">)</span><span class="operator">]</span></span><span class="text">
</span><span class="notcovered">                <span class="name">courses</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">exclude</span><span class="operator">(</span><span class="name">id__in</span><span class="operator">=</span><span class="name">enrollmentIds</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">else</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="comment">#anonymous users cannot see private courses
</span>                <span class="keyword">if</span> <span class="string">"anonCourses"</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">enrollmentIds</span> <span class="operator">=</span> <span class="operator">[</span><span class="name">c</span><span class="operator">.</span><span class="name">id</span> <span class="keyword">for</span> <span class="name">c</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span><span class="operator">]</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">courses</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">exclude</span><span class="operator">(</span><span class="name">id__in</span><span class="operator">=</span><span class="name">enrollmentIds</span><span class="operator">)</span><span class="operator">.</span><span class="name">exclude</span><span class="operator">(</span><span class="name">private</span><span class="operator">=</span><span class="name">True</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">else</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">courses</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">exclude</span><span class="operator">(</span><span class="name">private</span><span class="operator">=</span><span class="name">True</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'courses/join_course_form.html'</span><span class="operator">,</span> \
                          <span class="operator">{</span><span class="string">'join_courses'</span> <span class="operator">:</span> <span class="name">courses</span><span class="operator">}</span><span class="operator">)</span></span><span class="text">
</span><span class="text">
</span><span class="comment">#@login_required //login is not required to join a course
</span><span class="keyword">def</span> <span class="name">join_course_request</span><span class="operator">(</span><span class="name">request</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''Displays the classes a user can join'''</span><span class="text">
</span>        <span class="name">courseid</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">POST</span><span class="operator">[</span><span class="string">'courseid'</span><span class="operator">]</span><span class="text">
</span>        <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">id</span><span class="operator">=</span><span class="name">courseid</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">course</span><span class="operator">.</span><span class="name">private</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                <span class="name">view</span> <span class="operator">=</span> <span class="name">False</span></span><span class="text">
</span>        <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span>                <span class="name">view</span> <span class="operator">=</span> <span class="name">True</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">if</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">is_authenticated</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                <span class="name">user</span> <span class="operator">=</span> <span class="name">User</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">username</span><span class="operator">=</span><span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">                <span class="keyword">if</span> <span class="name">addUser</span><span class="operator">(</span><span class="name">course</span><span class="operator">,</span> <span class="name">user</span><span class="operator">,</span> <span class="name">view</span><span class="operator">)</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">message</span> <span class="operator">=</span> <span class="string">"Congratulations, you have been added to %s"</span> <span class="operator">%</span> <span class="name">course</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">else</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="name">message</span> <span class="operator">=</span> <span class="string">"You are already enrolled in %s"</span> <span class="operator">%</span> <span class="name">course</span></span><span class="text">
</span>        <span class="text">
</span>        <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span>                <span class="comment">#anonymous user is joining course
</span>                <span class="keyword">if</span> <span class="string">"anonCourses"</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">:</span><span class="text">
</span>                        <span class="text">
</span>                        <span class="keyword">if</span> <span class="name">course</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span><span class="operator">:</span><span class="text">
</span>                                <span class="name">message</span> <span class="operator">=</span> <span class="string">"You are already enrolled in %s"</span> <span class="operator">%</span> <span class="name">course</span><span class="text">
</span>                        <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span><span class="notcovered">                                <span class="name">courses</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">courses</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">course</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span> <span class="operator">=</span> <span class="name">courses</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">message</span> <span class="operator">=</span> <span class="string">"You have been temporarily added to %s"</span> <span class="operator">%</span> <span class="name">course</span></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">print</span><span class="operator">(</span><span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span><span class="operator">)</span></span><span class="text">
</span>                <span class="keyword">else</span><span class="operator">:</span><span class="text">
</span>                        <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'anonCourses'</span><span class="operator">]</span> <span class="operator">=</span> <span class="operator">[</span><span class="name">course</span><span class="operator">]</span><span class="text">
</span>                        <span class="name">message</span> <span class="operator">=</span> <span class="string">"You have been temporarily added to %s"</span><span class="text">
</span>                <span class="text">
</span>                <span class="name">user</span> <span class="operator">=</span> <span class="string">"Anonymous user"</span><span class="text">
</span>                <span class="text">
</span>                <span class="text">
</span>        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'courses/join_course_status.html'</span><span class="operator">,</span> \
                          <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span><span class="name">course</span><span class="operator">,</span> <span class="string">'user'</span><span class="operator">:</span><span class="name">user</span><span class="operator">,</span> <span class="string">'message'</span><span class="operator">:</span><span class="name">message</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="keyword">def</span> <span class="name">show_chat</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">''' 
        Shows the chat for the course
        '''</span><span class="text">
</span><span class="text">
</span>        <span class="keyword">try</span><span class="operator">:</span>    <span class="text">
</span>                <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span><span class="text">
</span>        <span class="keyword">except</span> <span class="name">Course</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span><span class="text">
</span>                <span class="keyword">raise</span> <span class="name">Http404</span><span class="text">
</span>                <span class="text">
</span>        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'chat/index.html'</span><span class="operator">,</span> <span class="operator">{</span><span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course_slug</span><span class="operator">,</span> <span class="string">'username'</span><span class="operator">:</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">username</span><span class="operator">,</span> <span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">}</span><span class="operator">)</span><span class="text">
</span><span class="text">
</span><span class="operator">@</span><span class="name">login_required</span><span class="text">
</span><span class="keyword">def</span> <span class="name">add_from_file</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="name">course_slug</span><span class="operator">)</span><span class="operator">:</span><span class="text">
</span>        <span class="string">'''
        Adds usernames from a text file
        pre: none
        post: for each username in request.FILES
                                enrollment.username.view = true
        '''</span><span class="text">
</span><span class="notcovered">        <span class="name">course</span> <span class="operator">=</span> <span class="name">Course</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">slug</span><span class="operator">=</span><span class="name">course_slug</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="name">enrollment</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">user</span><span class="operator">.</span><span class="name">enrollments</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">course</span><span class="operator">=</span><span class="name">course</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="name">failedList</span> <span class="operator">=</span> <span class="operator">[</span><span class="operator">]</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">        <span class="keyword">if</span> <span class="name">enrollment</span><span class="operator">.</span><span class="name">manage</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">for</span> <span class="name">k</span><span class="operator">,</span><span class="name">v</span><span class="operator">,</span> <span class="keyword">in</span> <span class="name">request</span><span class="operator">.</span><span class="name">FILES</span><span class="operator">.</span><span class="name">iteritems</span><span class="operator">(</span><span class="operator">)</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="comment">#print k, v
</span>                        <span class="name">infile</span> <span class="operator">=</span> <span class="name">request</span><span class="operator">.</span><span class="name">FILES</span><span class="operator">[</span><span class="name">k</span><span class="operator">]</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">                        <span class="name">output</span> <span class="operator">=</span> <span class="name">StringIO</span><span class="operator">.</span><span class="name">StringIO</span><span class="operator">(</span><span class="name">infile</span><span class="operator">.</span><span class="name">read</span><span class="operator">(</span><span class="operator">)</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span>                <span class="text">
</span><span class="notcovered">                        <span class="keyword">for</span> <span class="name">line</span> <span class="keyword">in</span> <span class="name">output</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                <span class="name">name</span> <span class="operator">=</span> <span class="name">line</span><span class="operator">.</span><span class="name">strip</span><span class="operator">(</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                                <span class="comment">#print line.strip()
</span>                                <span class="keyword">try</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                        <span class="comment">#if the user exists add it
</span>                                        <span class="name">user</span> <span class="operator">=</span> <span class="name">User</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">get</span><span class="operator">(</span><span class="name">username</span><span class="operator">=</span><span class="name">name</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">                                        <span class="name">addUser</span><span class="operator">(</span><span class="name">course</span><span class="operator">,</span> <span class="name">user</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered"></span><span class="text">
</span><span class="notcovered">                                <span class="keyword">except</span> <span class="name">User</span><span class="operator">.</span><span class="name">DoesNotExist</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                                        <span class="comment">#if the user does not exist print error message
</span>                                        <span class="name">failedList</span><span class="operator">.</span><span class="name">append</span><span class="operator">(</span><span class="name">name</span><span class="operator">)</span><span class="operator">;</span></span><span class="text">
</span><span class="notcovered">                                        <span class="comment">#return master_rtr(request, 'adduser/failed.html', \
</span>                                        <span class="comment">#                              {'course_slug':course_slug, \
</span>                                        <span class="comment">#                               'course': course})
</span></span>                                        <span class="text">
</span><span class="notcovered">                <span class="keyword">print</span> <span class="name">failedList</span></span><span class="text">
</span><span class="notcovered">                <span class="name">request</span><span class="operator">.</span><span class="name">session</span><span class="operator">[</span><span class="string">'badusers'</span><span class="operator">]</span><span class="operator">=</span><span class="name">failedList</span></span><span class="text">
</span><span class="notcovered">                <span class="keyword">return</span> <span class="name">HttpResponseRedirect</span><span class="operator">(</span><span class="name">reverse</span><span class="operator">(</span><span class="string">'courses.views.show_roster'</span><span class="operator">,</span> \
                                            <span class="name">args</span><span class="operator">=</span><span class="operator">[</span><span class="name">course_slug</span><span class="operator">]</span><span class="operator">)</span><span class="operator">)</span></span><span class="text">
</span><span class="notcovered">        <span class="keyword">else</span><span class="operator">:</span></span><span class="text">
</span><span class="notcovered">                        <span class="keyword">return</span> <span class="name">master_rtr</span><span class="operator">(</span><span class="name">request</span><span class="operator">,</span> <span class="string">'roster/invalid_permissions.html'</span><span class="operator">,</span> \
                                               <span class="operator">{</span><span class="string">'course'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">,</span> <span class="string">'course_slug'</span><span class="operator">:</span> <span class="name">course</span><span class="operator">.</span><span class="name">slug</span><span class="operator">}</span><span class="operator">)</span><span class="text"></span></span>
</pre></body>
</html>
